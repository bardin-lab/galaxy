{"version":3,"sources":["mvc/upload/upload-view.js"],"names":["Backbone","View","extend","options","nginx_upload_path","ftp_upload_site","default_genome","default_extension","height","width","auto","id","text","description","list_extensions","list_genomes","merge","this","_uploadButton2","default","e","onunload","percentage","self","ui_button","model","get","initialize","$el","_utils2","url","root","onclick","datatypes","preventDefault","show","push","key","extension","description_url","composite_files","sort","a","b","a_text","toLowerCase","b_text","setElement","datatypes_disable_auto","unshift","genomes","currHistoryPanel","current_user","Galaxy","user","modal","tabs","_uiTabs2","default_view","_defaultView2","add","title","_localization2","composite_view","_compositeView2","_collectionView2","_uiModal2","body","title_separator","window","setTimeout","currentHistory","currentFtp","toData","items","history_id","data","payload","tool_id","files","error_message","inputs","file_count","length","dbkey","file_type","index","it","set","prefix","name","JSON","stringify"],"mappings":"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","file":"../../../scripts/mvc/upload/upload-view.js","sourcesContent":["import _l from \"utils/localization\";\n/** Upload app contains the upload progress button and upload modal, compiles model data for API request **/\nimport Utils from \"utils/utils\";\nimport Modal from \"mvc/ui/ui-modal\";\nimport Tabs from \"mvc/ui/ui-tabs\";\nimport UploadButton from \"mvc/upload/upload-button\";\nimport UploadViewDefault from \"mvc/upload/default/default-view\";\nimport UploadViewComposite from \"mvc/upload/composite/composite-view\";\nimport UploadViewCollection from \"mvc/upload/collection/collection-view\";\nexport default Backbone.View.extend({\n    options: {\n        nginx_upload_path: \"\",\n        ftp_upload_site: \"n/a\",\n        default_genome: \"?\",\n        default_extension: \"auto\",\n        height: 500,\n        width: 900,\n        auto: {\n            id: \"auto\",\n            text: \"Auto-detect\",\n            description:\n                \"This system will try to detect the file type automatically. If your file is not detected properly as one of the known formats, it most likely means that it has some format problems (e.g., different number of columns on different rows). You can still coerce the system to set your data to the format you think it should be.  You can also upload compressed files, which will automatically be decompressed.\"\n        }\n    },\n\n    // contains all available dataset extensions/types\n    list_extensions: [],\n\n    // contains all available genomes\n    list_genomes: [],\n\n    initialize: function(options) {\n        var self = this;\n        this.options = Utils.merge(options, this.options);\n\n        // create view for upload/progress button\n        this.ui_button = new UploadButton.View({\n            onclick: function(e) {\n                e.preventDefault();\n                self.show();\n            },\n            onunload: function() {\n                var percentage = self.ui_button.model.get(\"percentage\", 0);\n                if (percentage > 0 && percentage < 100) {\n                    return \"Several uploads are queued.\";\n                }\n            }\n        });\n\n        // set element to button view\n        this.setElement(this.ui_button.$el);\n\n        // load extensions\n        var self = this;\n        Utils.get({\n            url: `${Galaxy.root}api/datatypes?extension_only=False`,\n            success: function(datatypes) {\n                for (var key in datatypes) {\n                    self.list_extensions.push({\n                        id: datatypes[key].extension,\n                        text: datatypes[key].extension,\n                        description: datatypes[key].description,\n                        description_url: datatypes[key].description_url,\n                        composite_files: datatypes[key].composite_files\n                    });\n                }\n                self.list_extensions.sort((a, b) => {\n                    var a_text = a.text && a.text.toLowerCase();\n                    var b_text = b.text && b.text.toLowerCase();\n                    return a_text > b_text ? 1 : a_text < b_text ? -1 : 0;\n                });\n                if (!self.options.datatypes_disable_auto) {\n                    self.list_extensions.unshift(self.options.auto);\n                }\n            }\n        });\n\n        // load genomes\n        Utils.get({\n            url: `${Galaxy.root}api/genomes`,\n            success: function(genomes) {\n                for (var key in genomes) {\n                    self.list_genomes.push({\n                        id: genomes[key][1],\n                        text: genomes[key][0]\n                    });\n                }\n                self.list_genomes.sort((a, b) => {\n                    if (a.id == self.options.default_genome) {\n                        return -1;\n                    }\n                    if (b.id == self.options.default_genome) {\n                        return 1;\n                    }\n                    return a.text > b.text ? 1 : a.text < b.text ? -1 : 0;\n                });\n            }\n        });\n    },\n\n    /** Show/hide upload dialog */\n    show: function() {\n        var self = this;\n        if (!Galaxy.currHistoryPanel || !Galaxy.currHistoryPanel.model) {\n            window.setTimeout(() => {\n                self.show();\n            }, 500);\n            return;\n        }\n        this.current_user = Galaxy.user.id;\n        if (!this.modal) {\n            this.tabs = new Tabs.View();\n            this.default_view = new UploadViewDefault(this);\n            this.tabs.add({\n                id: \"regular\",\n                title: _l(\"Regular\"),\n                $el: this.default_view.$el\n            });\n            this.composite_view = new UploadViewComposite(this);\n            this.tabs.add({\n                id: \"composite\",\n                title: _l(\"Composite\"),\n                $el: this.composite_view.$el\n            });\n            this.collection_view = new UploadViewCollection(this);\n            this.tabs.add({\n                id: \"collection\",\n                title: _l(\"Collection\"),\n                $el: this.collection_view.$el\n            });\n            this.modal = new Modal.View({\n                title: _l(\"Download from web or upload from disk\"),\n                body: this.tabs.$el,\n                height: this.options.height,\n                width: this.options.width,\n                closing_events: true,\n                title_separator: false\n            });\n        }\n        this.modal.show();\n    },\n\n    /** Refresh user and current history */\n    currentHistory: function() {\n        return this.current_user && Galaxy.currHistoryPanel.model.get(\"id\");\n    },\n\n    /** Get ftp configuration */\n    currentFtp: function() {\n        return this.current_user && this.options.ftp_upload_site;\n    },\n\n    /**\n     * Package API data from array of models\n     * @param{Array} items - Upload items/rows filtered from a collection\n     */\n    toData: function(items, history_id) {\n        // create dictionary for data submission\n        var data = {\n            payload: {\n                tool_id: \"upload1\",\n                history_id: history_id || this.currentHistory(),\n                inputs: {}\n            },\n            files: [],\n            error_message: null\n        };\n        // add upload tools input data\n        if (items && items.length > 0) {\n            var inputs = {\n                file_count: items.length,\n                dbkey: items[0].get(\"genome\", \"?\"),\n                file_type: items[0].get(\"extension\", \"auto\")\n            };\n            for (var index in items) {\n                var it = items[index];\n                it.set(\"status\", \"running\");\n                if (it.get(\"file_size\") > 0) {\n                    var prefix = `files_${index}|`;\n                    inputs[`${prefix}type`] = \"upload_dataset\";\n                    inputs[`${prefix}space_to_tab`] = (it.get(\"space_to_tab\") && \"Yes\") || null;\n                    inputs[`${prefix}to_posix_lines`] = (it.get(\"to_posix_lines\") && \"Yes\") || null;\n                    inputs[`${prefix}dbkey`] = it.get(\"genome\", null);\n                    inputs[`${prefix}file_type`] = it.get(\"extension\", null);\n                    switch (it.get(\"file_mode\")) {\n                        case \"new\":\n                            inputs[`${prefix}url_paste`] = it.get(\"url_paste\");\n                            break;\n                        case \"ftp\":\n                            inputs[`${prefix}ftp_files`] = it.get(\"file_path\");\n                            break;\n                        case \"local\":\n                            data.files.push({\n                                name: `${prefix}file_data`,\n                                file: it.get(\"file_data\")\n                            });\n                    }\n                } else {\n                    data.error_message = \"Upload content incomplete.\";\n                    it.set(\"status\", \"error\");\n                    it.set(\"info\", data.error_message);\n                    break;\n                }\n            }\n            data.payload.inputs = JSON.stringify(inputs);\n        }\n        return data;\n    }\n});\n"]}