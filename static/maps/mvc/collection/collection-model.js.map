{"version":3,"sources":["mvc/collection/collection-model.js"],"names":["DatasetCollectionElementMixin","defaults","model_class","element_identifier","element_index","element_type","_mergeObject","attributes","_","extend","object","element_id","id","options","this","idAttribute","Backbone","Model","apply","arguments","response","constructor","_baseMvc2","default","LoggableMixin","DCECollection","_logNamespace","model","DatasetCollectionElement","length","join","DatasetAssociation","mixin","toString","has","Galaxy","root","get","console","warn","_datasetModel2","prototype","_downloadQueryParameters","fileExt","elementIdentifier","debug","call","elements","hasDetails","DatasetDCECollection","DatasetDCE","DatasetCollection","SearchableModelMixin","collection_type","collectionClass","indexOf","NestedDCDCECollection","initialize","_createElementsModel","log","unset","silent","element","self","index","toJSON","json","inReadyState","populated","isDeletedOrPurged","getVisibleContents","filters","parse","parsed","create_time","update_time","Date","delete","recursive","purge","when","jQuery","method","save","deleted","undelete","searchAttributes","NestedDCDCE","objStr"],"mappings":"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","file":"../../../scripts/mvc/collection/collection-model.js","sourcesContent":["import DATASET_MODEL from \"mvc/dataset/dataset-model\";\nimport BASE_MVC from \"mvc/base-mvc\";\nimport Utils from \"utils/utils\";\nimport _l from \"utils/localization\";\n\n//==============================================================================\n/*\nNotes:\n\nTerminology:\n    DatasetCollection/DC : a container of datasets or nested DatasetCollections\n    Element/DatasetCollectionElement/DCE : an item contained in a DatasetCollection\n    HistoryDatasetCollectionAssociation/HDCA: a DatasetCollection contained in a history\n\n\nThis all seems too complex unfortunately:\n\n- Terminology collision between DatasetCollections (DCs) and Backbone Collections.\n- In the DatasetCollections API JSON, DC Elements use a 'Has A' stucture to *contain*\n    either a dataset or a nested DC. This would make the hierarchy much taller. I've\n    decided to merge the contained JSON with the DC element json - making the 'has a'\n    relation into an 'is a' relation. This seems simpler to me and allowed a lot of\n    DRY in both models and views, but may make tracking or tracing within these models\n    more difficult (since DatasetCollectionElements are now *also* DatasetAssociations\n    or DatasetCollections (nested)). This also violates the rule of thumb about\n    favoring aggregation over inheritance.\n- Currently, there are three DatasetCollection subclasses: List, Pair, and ListPaired.\n    These each should a) be usable on their own, b) be usable in the context of\n    nesting within a collection model (at least in the case of ListPaired), and\n    c) be usable within the context of other container models (like History or\n    LibraryFolder, etc.). I've tried to separate/extract classes in order to\n    handle those three situations, but it's proven difficult to do in a simple,\n    readable manner.\n- Ideally, histories and libraries would inherit from the same server models as\n    dataset collections do since they are (in essence) dataset collections themselves -\n    making the whole nested structure simpler. This would be a large, error-prone\n    refactoring and migration.\n\nMany of the classes and heirarchy are meant as extension points so, while the\nrelations and flow may be difficult to understand initially, they'll allow us to\nhandle the growth or flux dataset collection in the future (w/o actually implementing\nany YAGNI).\n\n*/\n//_________________________________________________________________________________________________ ELEMENTS\n/** @class mixin for Dataset collection elements.\n *      When collection elements are passed from the API, the underlying element is\n *          in a sub-object 'object' (IOW, a DCE representing an HDA will have HDA json in element.object).\n *      This mixin uses the constructor and parse methods to merge that JSON with the DCE attribtues\n *          effectively changing a DCE from a container to a subclass (has a --> is a).\n */\nvar DatasetCollectionElementMixin = {\n    /** default attributes used by elements in a dataset collection */\n    defaults: {\n        model_class: \"DatasetCollectionElement\",\n        element_identifier: null,\n        element_index: null,\n        element_type: null\n    },\n\n    /** merge the attributes of the sub-object 'object' into this model */\n    _mergeObject: function(attributes) {\n        // if we don't preserve and correct ids here, the element id becomes the object id\n        // and collision in backbone's _byId will occur and only\n        _.extend(attributes, attributes.object, {\n            element_id: attributes.id\n        });\n        delete attributes.object;\n        return attributes;\n    },\n\n    /** override to merge this.object into this */\n    constructor: function(attributes, options) {\n        // console.debug( '\\t DatasetCollectionElement.constructor:', attributes, options );\n        attributes = this._mergeObject(attributes);\n        this.idAttribute = \"element_id\";\n        Backbone.Model.apply(this, arguments);\n    },\n\n    /** when the model is fetched, merge this.object into this */\n    parse: function(response, options) {\n        var attributes = response;\n        attributes = this._mergeObject(attributes);\n        return attributes;\n    }\n};\n\n/** @class Concrete class of Generic DatasetCollectionElement */\nvar DatasetCollectionElement = Backbone.Model.extend(BASE_MVC.LoggableMixin)\n    .extend(DatasetCollectionElementMixin)\n    .extend({ _logNamespace: \"collections\" });\n\n//==============================================================================\n/** @class Base/Abstract Backbone collection for Generic DCEs - \n    current may be associated with a dataset (DatasetDCECollection)\n    or another collection (NestedDCDCECollection).\n*/\nvar DCECollection = Backbone.Collection.extend(BASE_MVC.LoggableMixin).extend(\n    /** @lends DCECollection.prototype */ {\n        _logNamespace: \"collections\",\n\n        model: DatasetCollectionElement,\n\n        /** String representation. */\n        toString: function() {\n            return [\"DatasetCollectionElementCollection(\", this.length, \")\"].join(\"\");\n        }\n    }\n);\n\n//==============================================================================\n/** @class Backbone model for a dataset collection element that is a dataset (HDA).\n */\nvar DatasetDCE = DATASET_MODEL.DatasetAssociation.extend(\n    BASE_MVC.mixin(\n        DatasetCollectionElementMixin,\n        /** @lends DatasetDCE.prototype */ {\n            /** url fn */\n            url: function() {\n                // won't always be an hda\n                if (!this.has(\"history_id\")) {\n                    console.warn(\"no endpoint for non-hdas within a collection yet\");\n                    // (a little silly since this api endpoint *also* points at hdas)\n                    return `${Galaxy.root}api/datasets`;\n                }\n                return `${Galaxy.root}api/histories/${this.get(\"history_id\")}/contents/${this.get(\"id\")}`;\n            },\n\n            defaults: _.extend(\n                {},\n                DATASET_MODEL.DatasetAssociation.prototype.defaults,\n                DatasetCollectionElementMixin.defaults\n            ),\n\n            _downloadQueryParameters: function() {\n                var fileExt = this.get(\"file_ext\");\n                var elementIdentifier = this.get(\"element_identifier\");\n                var parentHdcaId = this.get(\"parent_hdca_id\");\n                return `?to_ext=${fileExt}&hdca_id=${parentHdcaId}&element_identifier=${elementIdentifier}`;\n            },\n\n            // because all objects have constructors (as this hashmap would even if this next line wasn't present)\n            //  the constructor in hcontentMixin won't be attached by BASE_MVC.mixin to this model\n            //  - re-apply manually for now\n            /** call the mixin constructor */\n            constructor: function(attributes, options) {\n                this.debug(\"\\t DatasetDCE.constructor:\", attributes, options);\n                //DATASET_MODEL.DatasetAssociation.prototype.constructor.call( this, attributes, options );\n                DatasetCollectionElementMixin.constructor.call(this, attributes, options);\n            },\n\n            /** Does this model already contain detailed data (as opposed to just summary level data)? */\n            hasDetails: function() {\n                return this.elements && this.elements.length;\n            },\n\n            /** String representation. */\n            toString: function() {\n                var objStr = this.get(\"element_identifier\");\n                return `DatasetDCE({objStr})`;\n            }\n        }\n    )\n);\n\n//==============================================================================\n/** @class DCECollection of DatasetDCE's (a list of datasets, a pair of datasets).\n */\nvar DatasetDCECollection = DCECollection.extend(\n    /** @lends DatasetDCECollection.prototype */ {\n        model: DatasetDCE,\n\n        /** String representation. */\n        toString: function() {\n            return [\"DatasetDCECollection(\", this.length, \")\"].join(\"\");\n        }\n    }\n);\n\n//_________________________________________________________________________________________________ COLLECTIONS\n/** @class Backbone model for Dataset Collections.\n *      The DC API returns an array of JSON objects under the attribute elements.\n *      This model:\n *          - removes that array/attribute ('elements') from the model,\n *          - creates a bbone collection (of the class defined in the 'collectionClass' attribute),\n *          - passes that json onto the bbone collection\n *          - caches the bbone collection in this.elements\n */\nvar DatasetCollection = Backbone.Model.extend(BASE_MVC.LoggableMixin)\n    .extend(BASE_MVC.SearchableModelMixin)\n    .extend(\n        /** @lends DatasetCollection.prototype */ {\n            _logNamespace: \"collections\",\n\n            /** default attributes for a model */\n            defaults: {\n                /* 'list', 'paired', or 'list:paired' */\n                collection_type: null,\n                //??\n                deleted: false\n            },\n\n            /** Which class to use for elements */\n            collectionClass: function() {\n                if (this.attributes.collection_type.indexOf(\":\") > 0) {\n                    return NestedDCDCECollection;\n                } else {\n                    return DatasetDCECollection;\n                }\n            },\n\n            /** set up: create elements instance var and (on changes to elements) update them  */\n            initialize: function(model, options) {\n                this.debug(`${this}(DatasetCollection).initialize:`, model, options, this);\n                this.elements = this._createElementsModel();\n                this.on(\"change:elements\", function() {\n                    this.log(\"change:elements\");\n                    //TODO: prob. better to update the collection instead of re-creating it\n                    this.elements = this._createElementsModel();\n                });\n            },\n\n            /** move elements model attribute to full collection */\n            _createElementsModel: function() {\n                var collectionClass = this.collectionClass();\n                this.debug(`${this}._createElementsModel`, collectionClass, this.get(\"elements\"), this.elements);\n                //TODO: same patterns as DatasetCollectionElement _createObjectModel - refactor to BASE_MVC.hasSubModel?\n                var elements = this.get(\"elements\") || [];\n                this.unset(\"elements\", { silent: true });\n                var self = this;\n                _.each(elements, (element, index) => {\n                    _.extend(element, {\n                        parent_hdca_id: self.get(\"id\")\n                    });\n                });\n                this.elements = new collectionClass(elements);\n                //this.debug( 'collectionClass:', this.collectionClass + '', this.elements );\n                return this.elements;\n            },\n\n            // ........................................................................ common queries\n            /** pass the elements back within the model json when this is serialized */\n            toJSON: function() {\n                var json = Backbone.Model.prototype.toJSON.call(this);\n                if (this.elements) {\n                    json.elements = this.elements.toJSON();\n                }\n                return json;\n            },\n\n            /** Is this collection in a 'ready' state no processing (for the collection) is left\n             *  to do on the server.\n             */\n            inReadyState: function() {\n                var populated = this.get(\"populated\");\n                return this.isDeletedOrPurged() || populated;\n            },\n\n            //TODO:?? the following are the same interface as DatasetAssociation - can we combine?\n            /** Does the DC contain any elements yet? Is a fetch() required? */\n            hasDetails: function() {\n                return this.elements.length !== 0;\n            },\n\n            /** Given the filters, what models in this.elements would be returned? */\n            getVisibleContents: function(filters) {\n                // filters unused for now\n                return this.elements;\n            },\n\n            // ........................................................................ ajax\n            /** override to use actual Dates objects for create/update times */\n            parse: function(response, options) {\n                var parsed = Backbone.Model.prototype.parse.call(this, response, options);\n                if (parsed.create_time) {\n                    parsed.create_time = new Date(parsed.create_time);\n                }\n                if (parsed.update_time) {\n                    parsed.update_time = new Date(parsed.update_time);\n                }\n                return parsed;\n            },\n\n            /** save this collection, _Mark_ing it as deleted (just a flag) */\n            delete: function(recursive, purge, options) {\n                recursive = recursive || false;\n                purge = purge || false;\n                if (this.get(\"deleted\")) {\n                    return jQuery.when();\n                }\n                options = Utils.merge(options, { method: \"delete\" });\n                return this.save({ deleted: true, recursive: recursive, purge: purge }, options);\n            },\n            /** save this collection, _Mark_ing it as undeleted */\n            undelete: function(options) {\n                if (!this.get(\"deleted\")) {\n                    return jQuery.when();\n                }\n                return this.save({ deleted: false }, options);\n            },\n\n            /** Is this collection deleted or purged? */\n            isDeletedOrPurged: function() {\n                return this.get(\"deleted\") || this.get(\"purged\");\n            },\n\n            // ........................................................................ searchable\n            /** searchable attributes for collections */\n            searchAttributes: [\"name\", \"tags\"],\n\n            // ........................................................................ misc\n            /** String representation */\n            toString: function() {\n                var idAndName = [this.get(\"id\"), this.get(\"name\") || this.get(\"element_identifier\")];\n                return `DatasetCollection(${idAndName.join(\",\")})`;\n            }\n        }\n    );\n\n//_________________________________________________________________________________________________ NESTED COLLECTIONS\n// this is where things get weird, man. Weird.\n//TODO: it might be possible to compact all the following...I think.\n//==============================================================================\n/** @class Backbone model for a Generic DatasetCollectionElement that is also a DatasetCollection\n *      (a nested collection).\n */\nvar NestedDCDCE = DatasetCollection.extend(\n    BASE_MVC.mixin(\n        DatasetCollectionElementMixin,\n        /** @lends NestedDCDCE.prototype */ {\n            // because all objects have constructors (as this hashmap would even if this next line wasn't present)\n            //  the constructor in hcontentMixin won't be attached by BASE_MVC.mixin to this model\n            //  - re-apply manually it now\n            /** call the mixin constructor */\n            constructor: function(attributes, options) {\n                this.debug(\"\\t NestedDCDCE.constructor:\", attributes, options);\n                DatasetCollectionElementMixin.constructor.call(this, attributes, options);\n            },\n\n            /** String representation. */\n            toString: function() {\n                var objStr = this.object ? `${this.object}` : this.get(\"element_identifier\");\n                return [\"NestedDCDCE(\", objStr, \")\"].join(\"\");\n            }\n        }\n    )\n);\n\n//==============================================================================\n/** @class Backbone collection containing Generic NestedDCDCE's (nested dataset collections).\n */\nvar NestedDCDCECollection = DCECollection.extend(\n    /** @lends NestedDCDCECollection.prototype */ {\n        /** This is a collection of nested collections */\n        model: NestedDCDCE,\n\n        /** String representation. */\n        toString: function() {\n            return [\"NestedDCDCECollection(\", this.length, \")\"].join(\"\");\n        }\n    }\n);\n\n//==============================================================================\nexport default {\n    DatasetCollection: DatasetCollection\n};\n"]}